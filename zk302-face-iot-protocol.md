# `锁板<-->人脸/IOT集成模组` 对接协议

## 唤醒方式

锁板唤醒模组使用EN脚，拉高500ms唤醒模组，然后等待模组发送上电成功指令或者超时500ms后锁板采用指令查询,
查询指令为商汤协议中的`MID_GETSTATUS`指令

模组唤醒锁板使用串口唤醒，发送数据前先发送几个字节的0x00，然后延时10ms左右再发数据包或者采用重发机制

* 锁板最大唤醒时间：20ms
* 模组最大唤醒时间：300ms
* 唤醒后设备保持时间：3000ms

## 协议收发规则

1. 所有包的发送都采用立即回复的方式，每个包发送的超时时间为300ms
2. 需要为发送包做重发机制，即在发送包后时间超时还未收到回包需要再次发送此包，重发次数为3次
3. 不能连包发送，一个包一个回复，不能在没有回复或未超时之前发送其它包
4. 因为通信双方都可能处于休眠状态，请每次发包前遵循唤醒流程，不能主动猜测或强制要求对方处于唤醒状态

## 协议包格式

包类型 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
字节数 | 2 Bytes | 1 Byte | 2 Bytes | N Bytes | 1 Byte
人脸 | EF AA | face_command | length | data | checksum
IOT | EF 55 | iot_command | length | data | checksum
* face_command - 人脸相关命令
* iot_command - IOT相关命令
* length - 数据长度，采用大端模式，例如长度为：5，发送数据为：0x00 0x05
* data - 数据，可选
* checksum - 校验，除了包头之后的全部数据域的异或和
* 提示：**`数据域里的多字节类型数据均采用大端模式传输`**

人脸协议参考商汤人脸协议文档《SenseID V2智能人脸识别模组通信接口文档-20210910-V1.5.pdf》

## IOT相关的协议

命令列表

命令ID | 命令码 | 方向 | 命令说明
:-- | :-: | :-: | :--
MID_REPLY | 0x00 | 模块->锁板 | Reply 是模组对主控发送出的命令的应答
MID_NOTE | 0x01 | 模块->锁板 | Note 是模组主动发给主控的信息
MID_ENTER_NET_CONFIG | 0x10 | 锁板->模块 | 锁板请求模组进入配网模式
MID_EXIT_NET_CONFIG | 0x11 | 锁板->模块 | 锁板请求模组退出配网模式
MID_ENTER_FACTORY_RESET | 0x12 | 锁板->模块 | 锁板请求模组进入恢复出厂设置模式
MID_ENTER_FACTORY_TEST | 0x13 | 锁板->模块 | 锁板请求模组进入产测模式
MID_GET_NET_DATETIME | 0x14 | 锁板->模块 | 锁板请求模组获取网络时间
MID_DOOR_BELL_EVENT | 0x15 | 锁板->模块 | 锁板通知模组触发了门铃事件
MID_SET_LCD_ID | 0x16 | 锁板->模块 | 锁板设置模组LCD屏幕ID（对接多家屏幕，用指令来切换）
MID_MESSAGE_UPLOAD | 0x17 | 锁板->模块 | 锁板请求模组进行消息上报（开锁，关锁，报警等）
MID_NET_CONFIG_RESULT | 0x40 | 模块->锁板 | 模组通知锁板配网结果
MID_FACTORY_RESET_RESULT | 0x42 | 模块->锁板 | 模组通知锁板恢复出厂设置结果
MID_FACTORY_TEST_RESULT | 0x43 | 模块->锁板 | 模组通知锁板产测结果
MID_NET_DATETIME_RESULT | 0x44 | 模块->锁板 | 模组通知锁板网络时间获取结果
MID_REMOTE_REQ_UNLOCK | 0x80 | 模块->锁板 | 模组请求锁板远程开锁

## 锁板唤醒模组流程

1. 拉高EN至少500ms

2. 拉高的同时检测模组是否有回复上电完成包，如果500ms内收到回复，认为唤醒成功

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组回复 | EF AA | 01 | 00 01 | 00 | 00

3. 超时500ms未收到回复，主动发送`MID_GETSTATUS`指令获取模组状态，如果收到回复，认为唤醒成功，否则认为唤醒失败，结束此流程，终止后面的流程

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF AA | 11 | 00 00 | 无 | 11
模组回复 | EF AA | 00 | 00 03 | 11 00 status | checksum
* status - 模组状态，与商汤协议一致
* checksum - 校验

## 模组唤醒锁板流程

1. 通过串口发送5个字节的0x00，发完延时20ms

通信方向 | 数据
:-: | :-:
模组发送 | 00 00 00 00 00

## 人脸相关流程

### 录入人脸流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送人脸录入指令（0x13、0x1D、0x26），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送(0x13) | EF AA | 13 | 00 23 | admin name dir timeout | checksum
锁板发送(0x1D) | EF AA | 1D | 00 23 | admin name dir timeout | checksum
锁板发送(0x26) | EF AA | 26 | 00 28 | admin name dir type duplicate timeout 00 00 00 | checksum
模组回复 | EF AA | 00 | 00 02 | 26 00 | 24
* admin - 是否是管理员用户，0x00-普通用户，0x01-管理员用户
* name - 用户名字，32字节
* dir - 录入方向，0x01-中，0x02-右,0x04-左,0x08-下,0x10-上
* type - 录入方式，0x00-交互式，0x01-单帧
* duplicate - 是否可重复录入，0x00-不能重复，0x01-可重复
* timeout - 超时时间，单位：s
* checksum - 校验

3. 模组进行人脸录入，直到录入完成或超时
4. 用户中间想取消录入流程时，锁板发送停止流程指令（0x10），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF AA | 10 | 00 00 | 无 | 10
模组回复 | EF AA | 00 | 00 02 | 10 00 | 12

5. 模组唤醒锁板（参考唤醒流程）
6. 模组发送录入结果给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF AA | 26 | 00 03 | result user_id dir | checksum
锁板回复 | EF AA | 00 | 00 02 | 26 00 | 24
* result - 录入结果，与商汤协议兼容
* user_id - 录入编号，两个字节，大端模式
* dir - 录入方向，与商汤协议兼容，忽略此值
* checksum - 校验

### 验证人脸流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板检查系统是否处于演示模式，发送进入演示模式指令（0xFE），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF AA | FE | 00 01 | 01 | FE
锁板回复 | EF AA | 00 | 00 02 | FE 00 | FC

3. 锁板发送人脸验证指令（0x12），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF AA | 12 | 00 02 | 00 timeout | checksum
模组回复 | EF AA | 00 | 00 02 | 12 00 | 10
* timeout - 超时时间
* checksum - 校验

4. 模组进行人脸验证，直到验证完成或超时
5. 用户中间想取消验证流程时，锁板发送停止流程指令（0x10），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF AA | 10 | 00 00 | 无 | 10
模组回复 | EF AA | 00 | 00 02 | 10 00 | 12

6. 模组唤醒锁板（参考唤醒流程）
7. 模组发送验证结果给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF AA | 12 | 00 26 | result user_id name admin status | checksum
锁板回复 | EF AA | 00 | 00 02 | 12 00 | 10
* result - 验证结果，与商汤协议兼容
* user_id - 验证编号，两个字节，大端模式
* name - 用户名字，32字节
* admin - 是否是管理员用户，0x00-普通用户，0x01-管理员用户
* status - 识别成功时的人眼状态，与商汤协议兼容
* checksum - 校验

8. 锁板检查系统是否处于演示模式，发送退出演示模式指令（0xFE），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF AA | FE | 00 01 | 01 | FE
锁板回复 | EF AA | 00 | 00 02 | FE 00 | FC

### 删除单个人脸流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送人脸删除指令（0x20），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF AA | 20 | 00 02 | user_id | checksum
模组回复 | EF AA | 00 | 00 02 | 20 00 | 22
* user_id - 删除编号，两个字节，大端模式
* checksum - 校验

3. 模组进行人脸删除，直到删除完成或超时
4. 模组唤醒锁板（参考唤醒流程）
5. 模组发送删除结果给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF AA | 20 | 00 01 | result | checksum
锁板回复 | EF AA | 00 | 00 02 | 20 00 | 22
* result - 删除结果，与商汤协议兼容
* checksum - 校验

### 删除全部人脸流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送人脸清空指令（0x21），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF AA | 21 | 00 00 | 无 | 21
模组回复 | EF AA | 00 | 00 02 | 21 00 | 23

3. 模组进行人脸清空，直到清空完成或超时
4. 模组唤醒锁板（参考唤醒流程）
5. 模组发送清空结果给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF AA | 21 | 00 01 | result | checksum
锁板回复 | EF AA | 00 | 00 02 | 21 00 | 23
* result - 删除结果，与商汤协议兼容
* checksum - 校验

### 获取模组版本号流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送获取版本指令（0x30），模组回复版本号

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF AA | 30 | 00 00 | 无 | 30
模组回复 | EF AA | 22 | 00 02 | 30 00 version | checksum
* version - 版本信息字符串，32字节
* checksum - 校验

## IOT相关流程

### 配网流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送请求配网指令（0x10），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF 55 | 10 | 00 00 | 无 | 10
模组回复 | EF 55 | 00 | 00 02 | 10 00 | 12

3. 模组进行配网，直到配网完成或超时
4. 若锁板需要中途退出配网流程，锁板会主动给模组发送退出配网指令（0x11），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF 55 | 11 | 00 00 | 无 | 11
模组回复 | EF 55 | 00 | 00 02 | 11 00 | 13

5. 模组唤醒锁板（参考唤醒流程）
6. 模组发送配网结果给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF 55 | 40 | 00 01 | result | checksum
锁板回复 | EF 55 | 00 | 00 02 | 40 00 | 42
* result - 配网结果，0x00-成功，0x01-超时，0x02-失败
* checksum - 校验

### 恢复出厂设置流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送恢复出厂设置指令（0x12），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF 55 | 12 | 00 00 | 无 | 12
模组回复 | EF 55 | 00 | 00 02 | 12 00 | 10

3. 模组进行恢复出厂设置，直到恢复出厂设置完成或超时
4. 模组唤醒锁板（参考唤醒流程）
5. 模组发送恢复出厂设置结果给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF 55 | 42 | 00 01 | result | checksum
锁板回复 | EF 55 | 00 | 00 02 | 42 00 | 40
* result - 复出厂设置结果，0x00-成功，0x01-超时，0x02-失败
* checksum - 校验

### 产测流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送产测指令（0x13），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF 55 | 13 | 00 00 | 无 | 13
模组回复 | EF 55 | 00 | 00 02 | 13 00 | 11

3. 模组进行产测，直到产测完成或超时
4. 模组唤醒锁板（参考唤醒流程）
5. 模组发送产测结果给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF 55 | 43 | 00 01 | result | checksum
锁板回复 | EF 55 | 00 | 00 02 | 43 00 | 11
* result - 产测结果，0x00-成功，0x01-超时，0x02-失败
* checksum - 校验

### 获取网络时间

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送产测指令（0x14），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF 55 | 14 | 00 00 | 无 | 14
模组回复 | EF 55 | 00 | 00 02 | 14 00 | 16

3. 模组进行产测，直到产测完成或超时
4. 模组唤醒锁板（参考唤醒流程）
5. 模组发送产测结果给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF 55 | 44 | 00 0B | result timezone timestamp | checksum
锁板回复 | EF 55 | 00 | 00 02 | 44 00 | 42
* result - 获取时间结果，0x00-成功，0x01-超时，0x02-失败
* timezone - 时区，两个字节
  * 第一个字节表示时区正负，0x00-正时区，0x01-负时区
  * 第二个字节表示时区值，时区小时数*16+时区刻钟数，例如-3:30表示为：0x01 0x32
* timestamp - 时间戳，8字节，大端模式，uint64_t类型数据
* checksum - 校验

### 门铃事件流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送门铃事件触发指令（0x15），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF 55 | 15 | 00 01 | report | checksum
模组回复 | EF 55 | 00 | 00 02 | 15 00 | 17
* report - 是否需要上报云端门铃消息且远程开锁，0x00-仅亮屏，0x01-需要上报云端
* checksum - 校验

3. 模组进行门铃事件处理（联网上报、开屏幕，推流等）
4. 等待云端下发远程开锁指令或整个流程超时
5. 模组唤醒锁板（参考唤醒流程）
6. 模组发送请求远程开锁指令（0x80）给锁板

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
模组发送 | EF 55 | 80 | 00 00 | 无 | 80
锁板回复 | EF 55 | 00 | 00 02 | 80 00 | 82

### 切换屏幕ID流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送设置屏幕指令（0x16），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF 55 | 16 | 00 00 | lcd_id | checksum
模组回复 | EF 55 | 00 | 00 02 | 16 result | checksum
* lcd_id - 屏幕ID，根据中科使用屏幕进行编号
* result - 设置ID结果，0x00-成功，0x01-ID错误，0x02-不支持设置ID
* checksum - 校验

### 消息上报流程

1. 锁板唤醒模组（参考唤醒流程）
2. 锁板发送消息上报指令（0x17），模组回复收到应答，此时锁板可以进入其它流程或休眠

通信方向 | 包头 | 命令 | 长度 | 数据 | 校验
:-: | :-: | :-: | :-: | :-: | :-:
锁板发送 | EF 55 | 16 | length | type data | checksum
模组回复 | EF 55 | 00 | 00 02 | 17 0x00 | 15
* length - 数据长度，根据上报类型变化
* type - 上报类型
* data - 上报数据
* checksum - 校验
